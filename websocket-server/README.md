# WebSocket åŒæ­¥æœåŠ¡å™¨

è¿™æ˜¯ä¸€ä¸ªç”¨äºè¯­éŸ³è¯†åˆ«åŒæ­¥åŠŸèƒ½çš„WebSocketæœåŠ¡å™¨ï¼Œæ”¯æŒå‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¹‹é—´çš„å®æ—¶æ¶ˆæ¯ä¼ é€’ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¯ **æˆ¿é—´ç®¡ç†**: åŸºäºæ¿€æ´»å¯†é’¥çš„æˆ¿é—´éš”ç¦»
- ğŸ“¡ **æ¶ˆæ¯è·¯ç”±**: å‘é€ç«¯åˆ°æ¥æ”¶ç«¯çš„æ¶ˆæ¯è½¬å‘
- â¤ï¸ **å¿ƒè·³æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œæ¸…ç†æ–­å¼€çš„è¿æ¥
- ğŸ”’ **å‚æ•°éªŒè¯**: è¿æ¥å‚æ•°å’Œæ¶ˆæ¯æ ¼å¼éªŒè¯
- ğŸ“Š **çŠ¶æ€ç›‘æ§**: å®æ—¶è¿æ¥ç»Ÿè®¡å’Œæˆ¿é—´çŠ¶æ€

## é¡¹ç›®ç»“æ„

```
websocket-server/
â”œâ”€â”€ package.json          # æœåŠ¡å™¨ç«¯ä¾èµ–é…ç½®
â”œâ”€â”€ server.js             # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”œâ”€â”€ roomManager.js        # æˆ¿é—´å’Œå®¢æˆ·ç«¯è¿æ¥ç®¡ç†
â”œâ”€â”€ messageHandler.js     # æ¶ˆæ¯å¤„ç†å’Œè·¯ç”±é€»è¾‘
â”œâ”€â”€ utils.js              # å·¥å…·å‡½æ•°
â””â”€â”€ README.md            # ä½¿ç”¨è¯´æ˜
```

## å®‰è£…å’Œå¯åŠ¨

### æ–¹æ³•1: ä»ä¸»é¡¹ç›®å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…WebSocketæœåŠ¡å™¨ä¾èµ–
yarn ws:install

# å¯åŠ¨WebSocketæœåŠ¡å™¨
yarn ws:start

# åŒæ—¶å¯åŠ¨Next.jsåº”ç”¨å’ŒWebSocketæœåŠ¡å™¨
yarn dev:with-ws
```

### æ–¹æ³•2: ç‹¬ç«‹å¯åŠ¨

```bash
# è¿›å…¥æœåŠ¡å™¨ç›®å½•
cd websocket-server

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨æœåŠ¡å™¨
npm start

# å¼€å‘æ¨¡å¼ï¼ˆæ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯ï¼‰
npm run dev
```

## ç¯å¢ƒå˜é‡

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æœåŠ¡å™¨ï¼š

```bash
# WebSocketæœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤: 8080ï¼‰
WS_PORT=8080

# WebSocketæœåŠ¡å™¨ä¸»æœºï¼ˆé»˜è®¤: localhostï¼‰
WS_HOST=localhost

# è¿è¡Œç¯å¢ƒï¼ˆdevelopment/productionï¼‰
NODE_ENV=development
```

## è¿æ¥å‚æ•°

å®¢æˆ·ç«¯è¿æ¥WebSocketæœåŠ¡å™¨æ—¶éœ€è¦æä¾›ä»¥ä¸‹æŸ¥è¯¢å‚æ•°ï¼š

```
ws://localhost:8080/?key={ACTIVATION_KEY}&mode={MODE}&sessionId={SESSION_ID}
```

### å‚æ•°è¯´æ˜

- **key**: æ¿€æ´»å¯†é’¥ï¼Œç”¨äºæˆ¿é—´éš”ç¦»ï¼ˆå¿…éœ€ï¼‰
- **mode**: å®¢æˆ·ç«¯æ¨¡å¼ï¼Œ`sender`ï¼ˆå‘é€ç«¯ï¼‰æˆ– `receiver`ï¼ˆæ¥æ”¶ç«¯ï¼‰ï¼ˆå¿…éœ€ï¼‰
- **sessionId**: ä¼šè¯IDï¼Œå®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ï¼ˆå¿…éœ€ï¼‰

### ç¤ºä¾‹

```javascript
// å‘é€ç«¯è¿æ¥
const senderWs = new WebSocket('ws://localhost:8080/?key=user_activation_key_string&mode=sender&sessionId=abc123');

// æ¥æ”¶ç«¯è¿æ¥
const receiverWs = new WebSocket('ws://localhost:8080/?key=user_activation_key_string&mode=receiver&sessionId=def456');
```

## æ¶ˆæ¯æ ¼å¼

### è¯­éŸ³è¯†åˆ«æ¶ˆæ¯ï¼ˆå‘é€ç«¯ -> æ¥æ”¶ç«¯ï¼‰

```json
{
  "type": "speech_recognition",
  "timestamp": 1640995200000,
  "data": {
    "text": "è¯†åˆ«åˆ°çš„è¯­éŸ³æ–‡æœ¬",
    "isFinal": true,
    "language": "zh-CN",
    "sessionId": "abc123"
  }
}
```

### å¿ƒè·³æ¶ˆæ¯

```json
{
  "type": "ping",
  "timestamp": 1640995200000,
  "data": {}
}
```

### é”™è¯¯æ¶ˆæ¯

```json
{
  "type": "error",
  "timestamp": 1640995200000,
  "data": {
    "error": "é”™è¯¯æè¿°ä¿¡æ¯"
  }
}
```

### æˆ¿é—´çŠ¶æ€æ¶ˆæ¯

```json
{
  "type": "room_status",
  "timestamp": 1640995200000,
  "data": {
    "roomStats": {
      "total": 3,
      "senders": 1,
      "receivers": 2,
      "exists": true
    },
    "clientInfo": {
      "id": "sender_abc123_1640995200000",
      "mode": "sender",
      "sessionId": "abc123",
      "joinTime": 1640995200000
    }
  }
}
```

## å·¥ä½œæµç¨‹

1. **è¿æ¥å»ºç«‹**: 
   - å®¢æˆ·ç«¯è¿æ¥æ—¶éªŒè¯å‚æ•°
   - åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡å¹¶åŠ å…¥å¯¹åº”æˆ¿é—´
   - å‘é€æ¬¢è¿æ¶ˆæ¯å’Œæˆ¿é—´çŠ¶æ€

2. **æ¶ˆæ¯å¤„ç†**:
   - å‘é€ç«¯å‘é€è¯­éŸ³è¯†åˆ«æ¶ˆæ¯
   - æœåŠ¡å™¨éªŒè¯æ¶ˆæ¯æ ¼å¼
   - è½¬å‘æ¶ˆæ¯ç»™åŒæˆ¿é—´çš„æ‰€æœ‰æ¥æ”¶ç«¯

3. **è¿æ¥ç®¡ç†**:
   - å®šæœŸå¿ƒè·³æ£€æµ‹
   - è‡ªåŠ¨æ¸…ç†æ–­å¼€çš„è¿æ¥
   - å®æ—¶æ›´æ–°æˆ¿é—´çŠ¶æ€

## å¼€å‘å’Œè°ƒè¯•

### æ—¥å¿—çº§åˆ«

æœåŠ¡å™¨è¾“å‡ºä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼š

- `INFO`: ä¸€èˆ¬ä¿¡æ¯ï¼ˆè¿æ¥ã€æ–­å¼€ã€æ¶ˆæ¯å¤„ç†ï¼‰
- `WARN`: è­¦å‘Šä¿¡æ¯ï¼ˆéªŒè¯å¤±è´¥ã€å¼‚å¸¸æƒ…å†µï¼‰
- `ERROR`: é”™è¯¯ä¿¡æ¯ï¼ˆå¤„ç†å¼‚å¸¸ã€è¿æ¥é”™è¯¯ï¼‰
- `DEBUG`: è°ƒè¯•ä¿¡æ¯ï¼ˆå¿ƒè·³ã€è¯¦ç»†çŠ¶æ€ï¼‰

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**: æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®ï¼ŒæœåŠ¡å™¨æ˜¯å¦å¯åŠ¨
2. **æ¶ˆæ¯æœªè½¬å‘**: ç¡®è®¤æˆ¿é—´å†…æœ‰æ¥æ”¶ç«¯ï¼Œæ£€æŸ¥æ¿€æ´»å¯†é’¥æ˜¯å¦åŒ¹é…
3. **é¢‘ç¹æ–­çº¿**: æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§ï¼Œç¡®è®¤å¿ƒè·³æœºåˆ¶æ­£å¸¸

## APIå‚è€ƒ

### RoomManager ç±»

- `addClient(ws, params)`: æ·»åŠ å®¢æˆ·ç«¯åˆ°æˆ¿é—´
- `removeClient(clientId)`: ä»æˆ¿é—´ç§»é™¤å®¢æˆ·ç«¯
- `getReceivers(activationKey)`: è·å–æˆ¿é—´å†…æ¥æ”¶ç«¯
- `broadcastToReceivers(activationKey, message)`: å¹¿æ’­æ¶ˆæ¯åˆ°æ¥æ”¶ç«¯

### MessageHandler ç±»

- `handleMessage(client, messageStr)`: å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯
- `sendMessage(client, message)`: å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
- `forwardToReceivers(activationKey, message, senderClientId)`: è½¬å‘æ¶ˆæ¯ç»™æ¥æ”¶ç«¯

## è®¸å¯è¯

MIT License 